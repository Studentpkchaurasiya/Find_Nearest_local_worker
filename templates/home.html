{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="flex h-[80vh] bg-gray-100 rounded-lg overflow-hidden shadow-md">

    <!-- Sidebar -->
    <div class="w-1/3 bg-white p-6 border-r border-gray-200">
        <h2 class="text-xl font-bold text-gray-800 mb-6">Solution of all your issues</h2>

        <!-- Form -->
        <form id="issueForm" class="space-y-4">
            {% csrf_token %}
            
            <!-- Choose your issue -->
            <div>
                <label for="issue" class="block text-sm font-medium text-gray-700">Choose your issue</label>
                <select id="issue" name="issue" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200">
                    <option value="">-- Select an Issue --</option>
                    <option value="plumber">Plumbing</option>
                    <option value="electrician">Electrician</option>
                    <option value="painter">Painter</option>
                    <option value="carpenter">Carpenter</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <!-- Add your location with button -->
            <div>
                <label for="location" class="block text-sm font-medium text-gray-700">Add your location</label>
                <div class="flex">
                    <input type="text" id="location" name="location" placeholder="Enter your location"
                        class="mt-1 block w-full rounded-l-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200">
                    <button type="button" id="getLocationBtn"
                        class="mt-1 bg-gray-200 px-3 rounded-r-md hover:bg-gray-300">üìç</button>
                </div>
            </div>

            <!-- Describe your issue -->
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700">Describe your issue</label>
                <textarea id="description" name="description" rows="2" placeholder="Write here..."
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200"></textarea>
            </div>

            <!-- Find button -->
            <div>
                <button type="submit"
                    class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">Find</button>
            </div>
        </form>

        <!-- Result List -->
        <div id="result" 
            class="mt-6 space-y-3 max-h-64 overflow-y-auto pr-2 pb-4 custom-scroll">
        </div>

        <style>
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #9ca3af;  /* gray-400 */
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f3f4f6; /* gray-100 */
        }
        </style>

    </div>

    <!-- Map section -->
    <div class="flex-1">
        <div id="map" class="w-full h-full"></div>
    </div>

    <!-- Worker Modal -->
<div id="workerModal" class="fixed inset-0 hidden bg-black bg-opacity-50 flex items-center justify-center z-[9999]">
  <div class="bg-white w-96 p-6 rounded-lg shadow-lg relative">
    <button id="closeModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">‚úï</button>
    <h2 class="text-xl font-bold mb-2" id="modalName"></h2>
    <p><strong>Skill:</strong> <span id="modalSkill"></span></p>
    <p><strong>Location:</strong> <span id="modalLocation"></span></p>
    <p><strong>Experience:</strong> <span id="modalExp"></span> years</p>
    <p><strong>Rate:</strong> ‚Çπ<span id="modalRate"></span>/hour</p>
    <p><strong>Contact:</strong> <span id="modalEmail"></span></p>

    <!-- Booking status -->
    <p id="bookingStatus" class="mt-3 text-blue-600 font-semibold"></p>
    <p id="timer" class="text-red-600 font-semibold"></p>

    <!-- Booking Form -->
        <div class="mt-4">
            <label class="block text-sm font-medium mb-1">Date</label>
            <input type="date" id="bookingDate" class="w-full border p-2 rounded mb-3" required>

            <label class="block text-sm font-medium mb-1">Time</label>
            <input type="time" id="bookingTime" class="w-full border p-2 rounded mb-3" required>
        </div>

    <button id="bookBtn" class="mt-4 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
      Book
    </button>
  </div>
</div>


</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    let selectedWorker = null;  // üî• define globally
    var map = L.map('map').setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    var marker;

    // Form submit handler
    document.getElementById("issueForm").addEventListener("submit", function(e) {
        e.preventDefault();

        var issue = document.getElementById("issue").value;
        var locationInput = document.getElementById("location").value;
        var desc = document.getElementById("description").value;

        localStorage.setItem("userIssue",desc)
        localStorage.setItem("user_location",locationInput)

        if (!locationInput || !issue) {
            alert("Please select issue and location");
            return;
        }

        geocodeLocation(locationInput);

        //  Check user status is loged in or not
        fetch("/api/accounts/user/status/", { credentials: "include" })
        .then(res => res.json())
        .then(authData => {
            if (!authData.is_authenticated) {
                // Not logged in ‚Üí redirect
                window.location.href = "{% url 'login'%}";
            } else {
                // Logged in ‚Üí continue with search
                geocodeLocation(locationInput);

                fetch("/api/accounts/worker/search/?category=" + issue + "&location=" + encodeURIComponent(locationInput), {
                    credentials: "include"
                })
                .then(res => res.json())
                .then(data => {
                    showResults(data);
                })
                .catch(err => console.error(err));
            }
        })
        .catch(err => console.error("Auth check failed", err));
    });

    // Show results in sidebar
    function showResults(data) {
        let resultDiv = document.getElementById("result");
        resultDiv.innerHTML = ""; // clear old results

        if (data.length === 0) {
            resultDiv.innerHTML = "<p class='text-gray-500'>No workers found.</p>";
            return;
        }

        data.forEach(worker => {
    let card = document.createElement("div");
    card.className = "p-3 bg-gray-50 rounded-lg shadow cursor-pointer hover:bg-gray-100";
    
    card.innerHTML = `
        <h6 class="text-lg font-semibold">${worker.first_name} ${worker.last_name}</h6>
        <p class="text-sm text-gray-600">Skill: ${worker.category}</p>
        <p class="text-sm text-gray-600">Is Available: ${worker.is_available}</p>
        <p class="text-sm text-gray-600">Experience years: ${worker.experience_years}</p>
    `;

    // when user clicks a worker card ‚Üí show modal
    card.addEventListener("click", function () {
        selectedWorker = worker; 
        document.getElementById("modalName").innerText = worker.first_name + " " + worker.last_name;
        document.getElementById("modalSkill").innerText = worker.category;
        document.getElementById("modalLocation").innerText = worker.location;
        document.getElementById("modalExp").innerText = worker.experience_years;
        document.getElementById("modalRate").innerText = worker.hourly_rate;
        document.getElementById("modalEmail").innerText = worker.email || "N/A";

        document.getElementById("bookBtn").dataset.id = worker.id;  // store worker id

        // üëá show the modal (remove hidden)
        document.getElementById("workerModal").classList.remove("hidden");
    });

    resultDiv.appendChild(card);
});
    }

  // for pop close
document.getElementById("closeModal").addEventListener("click", function () {
    document.getElementById("workerModal").classList.add("hidden");
});

// On book btn
document.addEventListener("DOMContentLoaded", () => {
    const bookBtn = document.getElementById("bookBtn");
    if (bookBtn) {
        bookBtn.addEventListener("click", async () => {
            if (!selectedWorker) return;

            let date = document.getElementById("bookingDate").value;
            let time = document.getElementById("bookingTime").value;
            let user_issue = localStorage.getItem("userIssue")
            let description = user_issue;  // issue from Find page
            let location = localStorage.getItem("user_location")
            
            
            if (!date || !time || !description) {
                alert("Please select date, time and enter issue on Find page.");
            return;
            }

            try {
                let res = await fetch("/api/bookings/create/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    credentials: "include",   // send cookies
                    body: JSON.stringify({
                        worker: selectedWorker.user_id,
                        date: date,
                        time: time,
                        description: description,
                        location: location
                    })
                });
                let booking_data = await res.json()
                if (res.ok) {
                    document.getElementById("bookingStatus").innerText =
                        "‚è≥ Pending - Waiting for worker response...";
                    startCountdown(booking_data.id);
                } else {
                    let errorMsg = await res.json();
                    document.getElementById("bookingStatus").innerText =
                        `Booking failed: ${errorMsg.detail || "Error"}`;
                }
            } catch (err) {
                console.error(err);
                document.getElementById("bookingStatus").innerText =
                    "‚ùå Worker not available";
            }
        });
    }
});

// Start 1-minute countdown
let bookingTimer;
let statusInterval;

function startCountdown(bookingId) {
    let countdown = 60;
    document.getElementById("timer").innerText = `Time left: ${countdown}s`;

    // Countdown Timer (‡§π‡§∞ 1 ‡§∏‡•á‡§ï‡§Ç‡§°)
    bookingTimer = setInterval(() => {
        countdown--;
        document.getElementById("timer").innerText = `Time left: ${countdown}s`;

        if (countdown <= 0) {
            clearInterval(bookingTimer);
            clearInterval(statusInterval); // API polling stop
            document.getElementById("bookingStatus").innerText =
                "Rejected - Worker did not respond in time.";
            document.getElementById("timer").innerText = "";
        }
    }, 1000);

    // API Polling ‡§π‡§∞ 2 ‡§∏‡•á‡§ï‡§Ç‡§°
    statusInterval = setInterval(() => {
        fetch(`/api/bookings/${bookingId}/status/check/`, { credentials: "include" })
            .then(res => res.json())
            .then(data => {
                if (data.status !== "pending") {
                    clearInterval(statusInterval); // stop polling
                    clearInterval(bookingTimer);   // stop countdown

                    document.getElementById("bookingStatus").innerText =
                        data.status === "accepted"
                            ? "Accepted by worker ‚úÖ"
                            : "Rejected by worker ‚ùå";

                    document.getElementById("timer").innerText = "";
                }
            })
            .catch(err => console.error("Error checking status:", err));
    }, 2000); // ‡§π‡§∞ 2 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§Æ‡•á‡§Ç check
}



    // Function to geocode location name to coordinates
    function geocodeLocation(location) {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`)
            .then(res => res.json())
            .then(data => {
                if (data.length > 0) {
                    var lat = data[0].lat;
                    var lon = data[0].lon;
                    updateMap(lat, lon);
                } else {
                    alert("Location not found!");
                }
            })
            .catch(err => console.error(err));
    }

    // Function to update map & marker
    function updateMap(lat, lon) {
        map.setView([lat, lon], 13);
        if (marker) {
            marker.setLatLng([lat, lon]);
        } else {
            marker = L.marker([lat, lon]).addTo(map);
        }
    }

    //  Get Location Button
    document.getElementById("getLocationBtn").addEventListener("click", function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lon = position.coords.longitude;

                // Reverse geocode to get address
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.display_name) {
                            document.getElementById("location").value = data.display_name;
                        }
                    })
                    .catch(err => console.error(err));

                updateMap(lat, lon);
            }, function(error) {
                alert("Unable to retrieve your location");
            });
        } else {
            alert("Geolocation is not supported by your browser");
        }
    });
</script>
{% endblock %}
